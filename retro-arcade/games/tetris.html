<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tetris</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body>
  <!-- Back button with sound -->
  <button id="backBtn" onclick="playSound('back'); window.location.href='../index.html'">â¬… Back to Arcade</button>

  <div id="overlay">
    <div class="game-message" id="gameMessage">GAME OVER</div>
    <div class="restart-message">Press Enter to Restart</div>
  </div>

  <canvas id="tetris" width="240" height="400"></canvas>

<script src="../js/sound.js"></script>
<script>
const canvas = document.getElementById("tetris");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("overlay");
const gameMessage = document.getElementById("gameMessage");

const ROWS = 20;
const COLS = 12;
const BLOCK_SIZE = 20;

let board, piece, score, gameOver, game;

function initGame(){
  board = Array.from({length:ROWS},()=>Array(COLS).fill(0));
  piece = randomPiece();
  score = 0;
  gameOver = false;
  overlay.style.display = "none";
  clearInterval(game);
  game = setInterval(update,500);
}

function randomPiece(){
  const pieces = [
    [[1,1,1,1]],
    [[1,1],[1,1]],
    [[0,1,0],[1,1,1]],
    [[1,0,0],[1,1,1]],
    [[0,0,1],[1,1,1]],
    [[1,1,0],[0,1,1]],
    [[0,1,1],[1,1,0]]
  ];
  return { shape: pieces[Math.floor(Math.random()*pieces.length)], x:4, y:0 };
}

document.addEventListener("keydown", e=>{
  if(e.key==="ArrowLeft") piece.x--;
  if(e.key==="ArrowRight") piece.x++;
  if(e.key==="ArrowDown") piece.y++;
  if(e.key==="ArrowUp") rotatePiece();
  if(e.key==="Enter" && gameOver){ initGame(); }
});

function rotatePiece(){
  piece.shape = piece.shape[0].map((_,i)=>piece.shape.map(row=>row[i])).reverse();
}

function mergePiece(){
  for(let r=0;r<piece.shape.length;r++){
    for(let c=0;c<piece.shape[r].length;c++){
      if(piece.shape[r][c]){
        board[piece.y+r][piece.x+c]=1;
      }
    }
  }
}

function collision(){
  for(let r=0;r<piece.shape.length;r++){
    for(let c=0;c<piece.shape[r].length;c++){
      if(piece.shape[r][c]){
        let newY = piece.y+r;
        let newX = piece.x+c;
        if(newY>=ROWS || newX<0 || newX>=COLS || board[newY][newX]){
          return true;
        }
      }
    }
  }
  return false;
}

function clearLines(){
  for(let r=ROWS-1;r>=0;r--){
    if(board[r].every(cell=>cell)){
      board.splice(r,1);
      board.unshift(Array(COLS).fill(0));
      score+=100;
      playSound("tetris-line"); // line clear sound
    }
  }
}

function drawBoard(){
  ctx.fillStyle="black";
  ctx.fillRect(0,0,canvas.width,canvas.height);
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(board[r][c]){
        ctx.fillStyle="#0ff";
        ctx.fillRect(c*BLOCK_SIZE,r*BLOCK_SIZE,BLOCK_SIZE,BLOCK_SIZE);
      }
    }
  }
}

function drawPiece(){
  ctx.fillStyle="#ff0";
  for(let r=0;r<piece.shape.length;r++){
    for(let c=0;c<piece.shape[r].length;c++){
      if(piece.shape[r][c]){
        ctx.fillRect((piece.x+c)*BLOCK_SIZE,(piece.y+r)*BLOCK_SIZE,BLOCK_SIZE,BLOCK_SIZE);
      }
    }
  }
}

function update(){
  piece.y++;
  if(collision()){
    piece.y--;
    mergePiece();
    clearLines();
    piece = randomPiece();
    if(collision()){
      clearInterval(game);
      gameOver=true;
      overlay.style.display = "flex";
      gameMessage.textContent = "GAME OVER";
      playSound("game-over"); // game over sound
    }
  }
  drawBoard();
  drawPiece();
  ctx.fillStyle="white";
  ctx.font="16px Arial";
  ctx.fillText("Score: "+score,10,20);

  // win condition (arbitrary score threshold)
  if(score>=1000){
    clearInterval(game);
    gameOver=true;
    overlay.style.display = "flex";
    gameMessage.textContent = "YOU WIN!";
    playSound("win"); // win sound
  }
}

initGame();
</script>
</body>
</html>