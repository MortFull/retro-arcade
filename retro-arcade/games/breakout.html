<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Breakout — IvoCade</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    #overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      background: rgba(0,0,0,0.7);
      color: #0ff;
      font-family: 'Courier New', monospace;
      text-shadow: 0 0 10px #0ff;
    }
    .game-message { font-size: 2em; margin-bottom: 10px; }
    .restart-message { font-size: 1.2em; color: #888; }
  </style>
</head>
<body>
  <h1>Breakout</h1>

  <div class="game-container">
    <canvas class="default" id="breakout" width="480" height="320"></canvas>
    <div class="scoreboard" id="scoreboard">Score: 0 | Lives: 3</div>
    <div class="game-controls">
      <button class="restart-btn" aria-label="Restart game"></button>
      <button class="back-btn" aria-label="Back to menu"></button>
      <button class="sound-toggle" aria-label="Toggle sound"></button>
    </div>
  </div>

  <div id="overlay">
    <div class="game-message" id="gameMessage">GAME OVER</div>
    <div class="restart-message">Press Enter to Restart</div>
  </div>

  <footer><p>© Ivaylo's Arcade</p></footer>

  <script src="../js/sound.js"></script>
  <script>
    const canvas = document.getElementById("breakout");
    const ctx = canvas.getContext("2d");
    const overlay = document.getElementById("overlay");
    const gameMessage = document.getElementById("gameMessage");
    const scoreboard = document.getElementById("scoreboard");

    let ball, paddle, bricks, score, lives, gameOver, game;

    const brickRowCount = 4;
    const brickColumnCount = 6;
    const brickWidth = 60;
    const brickHeight = 20;
    const brickPadding = 10;
    const brickOffsetTop = 30;
    const brickOffsetLeft = 30;

    // Difficulty from hub
    const params = new URLSearchParams(window.location.search);
    const difficulty = params.get("difficulty") || "normal";
    let ballSpeed = difficulty === "easy" ? 2 : difficulty === "hard" ? 4 : 3;

    // Load sprite sheet
    const sprite = new Image();
    sprite.src = "../assets/ui/logos.png";

    const logoMap = {
      ball:   {x:0,   y:0,   w:64, h:64},
      paddle: {x:64,  y:0,   w:64, h:64},
      brick:  {x:128, y:0,   w:64, h:64}
    };

    function drawLogo(name, dx, dy, dw, dh){
      const s = logoMap[name];
      ctx.drawImage(sprite, s.x, s.y, s.w, s.h, dx, dy, dw, dh);
    }

    function initGame(){
      ball = { x: canvas.width/2, y: canvas.height-30, dx: ballSpeed, dy: -ballSpeed, r: 8 };
      paddle = { h: 10, w: 75, x: (canvas.width-75)/2 };
      score = 0;
      lives = 3;
      gameOver = false;
      overlay.style.display = "none";

      bricks = [];
      for(let c=0;c<brickColumnCount;c++){
        bricks[c] = [];
        for(let r=0;r<brickRowCount;r++){
          bricks[c][r] = { x:0, y:0, status:1 };
        }
      }

      clearInterval(game);
      updateScoreboard();
      playStart();
      game = setInterval(draw,20);
    }

    document.addEventListener("keydown", keyDownHandler);
    document.addEventListener("keyup", keyUpHandler);

    let rightPressed=false, leftPressed=false;

    function keyDownHandler(e){
      if(e.key==="ArrowRight") rightPressed=true;
      else if(e.key==="ArrowLeft") leftPressed=true;
      if(e.key==="Enter" && gameOver){ initGame(); }
    }
    function keyUpHandler(e){
      if(e.key==="ArrowRight") rightPressed=false;
      else if(e.key==="ArrowLeft") leftPressed=false;
    }

    function collisionDetection(){
      for(let c=0;c<brickColumnCount;c++){
        for(let r=0;r<brickRowCount;r++){
          let b=bricks[c][r];
          if(b.status===1){
            if(ball.x> b.x && ball.x< b.x+brickWidth && ball.y> b.y && ball.y< b.y+brickHeight){
              ball.dy=-ball.dy;
              b.status=0;
              score++;
              updateScoreboard();
              playScore();
              if(score===brickRowCount*brickColumnCount){
                clearInterval(game);
                gameOver=true;
                overlay.style.display = "flex";
                gameMessage.textContent = "YOU WIN!";
                playLevelUp();

                // Save highscore + stats
                ivocadeHelpers.saveHighScore("breakout", score);
                ivocadeHelpers.trackStats("breakout", score);
              }
            }
          }
        }
      }
    }

    function updateScoreboard(){
      scoreboard.innerHTML = `Score: ${score} | Lives: ${lives}`;
    }

    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // draw bricks
      for(let c=0;c<brickColumnCount;c++){
        for(let r=0;r<brickRowCount;r++){
          if(bricks[c][r].status===1){
            let brickX=(c*(brickWidth+brickPadding))+brickOffsetLeft;
            let brickY=(r*(brickHeight+brickPadding))+brickOffsetTop;
            bricks[c][r].x=brickX;
            bricks[c][r].y=brickY;
            drawLogo("brick", brickX, brickY, brickWidth, brickHeight);
          }
        }
      }

      // draw ball
      drawLogo("ball", ball.x-ball.r, ball.y-ball.r, ball.r*2, ball.r*2);

      // draw paddle
      drawLogo("paddle", paddle.x, canvas.height-paddle.h, paddle.w, paddle.h);

      collisionDetection();

      if(gameOver){ return; }

      if(ball.x+ball.dx>canvas.width-ball.r || ball.x+ball.dx<ball.r){
        ball.dx=-ball.dx;
        playHit();
      }
      if(ball.y+ball.dy<ball.r){
        ball.dy=-ball.dy;
      }
      else if(ball.y+ball.dy>canvas.height-ball.r){
        if(ball.x>paddle.x && ball.x<paddle.x+paddle.w){
          ball.dy=-ball.dy;
          playHit();
        }
        else {
          lives--;
          updateScoreboard();
          if(!lives){
            clearInterval(game);
            gameOver=true;
            overlay.style.display = "flex";
            gameMessage.textContent = "GAME OVER";
            playGameOver();

            // Save highscore + stats
            ivocadeHelpers.saveHighScore("breakout", score);
            ivocadeHelpers.trackStats("breakout", score);
          } else {
            ball.x=canvas.width/2; ball.y=canvas.height-30; ball.dx=ballSpeed; ball.dy=-ballSpeed;
            paddle.x=(canvas.width-paddle.w)/2;
          }
        }
      }

      ball.x+=ball.dx;
      ball.y+=ball.dy;

      if(rightPressed && paddle.x<canvas.width-paddle.w){ paddle.x+=7; }
      else if(leftPressed && paddle.x>0){ paddle.x-=7; }
    }

    // Restart button
    document.querySelector('.restart-btn').addEventListener('click', () => {
      initGame();
    });

    initGame();
  </script>
</body>
</html>